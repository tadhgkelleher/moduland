<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Modular - Premium modular housing solutions for landowners and buyers in Ireland.">
    <title>Modular - Luxury Modular Homes</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    
    <style>
        /* Minimal CSS Reset */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: linear-gradient(135deg, #2E4A3D 0%, #1A2F27 100%);
            --accent: linear-gradient(135deg, #6B9AC4 0%, #4A7BA3 100%);
            --highlight: linear-gradient(135deg, #F5E8C7 0%, #E8D9A8 100%);
            --light-bg: linear-gradient(180deg, #F9F9F9 0%, #EDEDED 100%);
            --white: #FFFFFF; --text: #333333; --text-light: #666666;
            --shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 10px 30px rgba(0, 0, 0, 0.15);
            --border-light: #D9D9D9; --transition: all 0.3s ease-in-out;
            --border-radius-md: 8px; --border-radius-lg: 12px;
            --gradient-overlay: linear-gradient(180deg, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.8) 100%);
            --cta-hover: linear-gradient(135deg, #4A7BA3 0%, #E8D9A8 100%);
            --modal-bg: linear-gradient(135deg, #F9F9F9 0%, #E8ECEF 100%);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; line-height: 1.7; background: var(--light-bg); color: var(--text); overflow-x: hidden; }
        .container { max-width: 1280px; margin: 0 auto; padding: 0 20px; }
        :focus-visible { outline: 3px solid #4A7BA3; outline-offset: 2px; }
        header { background: var(--primary); color: var(--white); padding: 2rem 0; position: sticky; top: 0; z-index: 1000; box-shadow: var(--shadow); }
        header h1 { font-size: 2.6rem; font-weight: 700; text-align: center; text-transform: uppercase; letter-spacing: 1.5px; background: var(--highlight); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        header p { font-size: 1.1rem; opacity: 0.9; text-align: center; margin-top: 0.25rem; }
        main { padding-top: 1rem; }
        .hero { background: linear-gradient(135deg, #FFFFFF 0%, #E8ECEF 100%); padding: 3.5rem 2rem; text-align: center; margin: 2rem 0; border-radius: var(--border-radius-lg); box-shadow: var(--shadow); animation: fadeIn 1s ease-out; position: relative; overflow: hidden; }
        .hero::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at top left, rgba(107,154,196,0.2), transparent 70%); z-index: 0; }
        .hero h2, .hero p { position: relative; z-index: 1; }
        .hero h2 { font-size: 2.4rem; background: var(--primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1.25rem; }
        .hero p { font-size: 1.15rem; max-width: 750px; margin: 0 auto; color: var(--text-light); }
        .gallery { padding: 3.5rem 0; text-align: center; background: var(--light-bg); }
        .gallery h2 { font-size: 2.1rem; background: var(--primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 2rem; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; }
        .gallery-item { position: relative; overflow: hidden; border-radius: var(--border-radius-lg); box-shadow: var(--shadow); transition: transform var(--transition), box-shadow var(--transition); background: var(--light-bg); }
        .gallery-item:hover, .gallery-item:focus-within { transform: scale(1.03); box-shadow: var(--shadow-hover); }
        .gallery-item img { width: 100%; height: 250px; object-fit: cover; display: block; transition: transform var(--transition); }
        .gallery-item:hover img { transform: scale(1.05); }
        .gallery-caption { position: absolute; bottom: 0; left: 0; right: 0; background: var(--gradient-overlay); color: var(--white); padding: 0.8rem 1rem; font-size: 0.9rem; transform: translateY(100%); transition: transform var(--transition); }
        .gallery-item:hover .gallery-caption, .gallery-item:focus-within .gallery-caption { transform: translateY(0); }
        .cta-sections { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin: 2.5rem 0; }
        .cta-section { background: linear-gradient(135deg, #FFFFFF 0%, #E8ECEF 100%); padding: 2.25rem; border-radius: var(--border-radius-lg); box-shadow: var(--shadow); text-align: center; transition: transform var(--transition), box-shadow var(--transition); position: relative; overflow: hidden; }
        .cta-section::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at bottom right, rgba(245,232,199,0.2), transparent 70%); z-index: 0; transition: opacity var(--transition); opacity: 0; }
        .cta-section:hover::before { opacity: 1; }
        .cta-section:hover { transform: translateY(-10px); box-shadow: var(--shadow-hover); }
        .cta-section h2, .cta-section p, .cta-button { position: relative; z-index: 1; }
        .cta-section h2 { font-size: 1.9rem; background: var(--primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1rem; }
        .cta-section p { font-size: 1.05rem; color: var(--text-light); margin-bottom: 1.5rem; }
        .cta-button { display: inline-block; background: var(--accent); color: var(--white); padding: 0.8rem 1.8rem; text-decoration: none; border-radius: 50px; font-weight: 600; transition: background var(--transition), transform var(--transition); border: 2px solid transparent; }
        .cta-button:hover, .cta-button:focus-visible { background: var(--cta-hover); transform: scale(1.05); border-color: #1A2F27; }
        .how-it-works { background: linear-gradient(135deg, #FFFFFF 0%, #E8ECEF 100%); padding: 3.5rem 2rem; margin: 2.5rem 0; border-radius: var(--border-radius-lg); text-align: center; box-shadow: var(--shadow); }
        .how-it-works h2 { font-size: 2.1rem; background: var(--primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1.75rem; }
        .how-it-works ol { list-style-position: inside; padding-left: 0; max-width: 600px; margin: 0 auto; }
        .how-it-works li { font-size: 1.1rem; color: var(--text-light); margin: 0.7rem 0; text-align: left; transition: color var(--transition); }
        .how-it-works li:hover { color: #2E4A3D; }
        .how-it-works li::marker { color: #2E4A3D; font-weight: bold; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(0,0,0,0.6) 0%, rgba(26,47,39,0.8) 100%); align-items: center; justify-content: center; z-index: 2000; opacity: 0; transition: opacity 0.3s ease-in-out; padding: 20px; }
        .modal.is-open { display: flex; opacity: 1; }
        .modal-content-wrapper { background: var(--modal-bg); padding: 2.5rem; border-radius: var(--border-radius-lg); max-width: 550px; width: 100%; text-align: center; position: relative; box-shadow: var(--shadow-hover); transform: scale(0.95); transition: transform 0.3s ease-in-out; max-height: 90vh; overflow-y: auto; }
        .modal.is-open .modal-content-wrapper { transform: scale(1); }
        .modal-content-wrapper h2 { font-size: 1.9rem; background: var(--primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1.25rem; }
        .modal-content-wrapper form { display: flex; flex-direction: column; gap: 1rem; }
        .modal-content-wrapper label { text-align: left; font-size: 0.9rem; color: #2E4A3D; font-weight: 600; margin-bottom: -0.5rem; }
        .modal-content-wrapper input, .modal-content-wrapper select, .modal-content-wrapper textarea { padding: 0.8rem; border: 1px solid var(--border-light); border-radius: var(--border-radius-md); font-size: 1rem; width: 100%; background: linear-gradient(180deg, #FFFFFF 0%, #E8ECEF 100%); transition: border-color var(--transition); }
        .modal-content-wrapper input:focus-visible, .modal-content-wrapper select:focus-visible, .modal-content-wrapper textarea:focus-visible { border-color: #4A7BA3; outline: none; }
        .modal-content-wrapper textarea { resize: vertical; min-height: 100px; }
        .modal-content-wrapper button[type="submit"] { background: var(--accent); color: var(--white); padding: 0.9rem; border: none; border-radius: 50px; font-weight: 600; cursor: pointer; transition: background var(--transition), transform var(--transition); }
        .modal-content-wrapper button[type="submit"]:hover, .modal-content-wrapper button[type="submit"]:focus-visible { background: var(--cta-hover); transform: translateY(-2px); }
        .modal-content-wrapper button[type="submit"]:disabled { background-color: #ccc; cursor: not-allowed; }
        .close-modal { position: absolute; top: 12px; right: 15px; font-size: 2rem; font-weight: bold; line-height: 1; cursor: pointer; color: var(--text-light); background: none; border: none; padding: 0.25rem; }
        .close-modal:hover, .close-modal:focus-visible { color: #2E4A3D; }
        footer { background: var(--primary); color: var(--white); padding: 2rem 1rem; text-align: center; margin-top: 3rem; position: relative; }
        footer::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, rgba(107,154,196,0.3), transparent 70%); z-index: 0; }
        footer p, .social-icons { position: relative; z-index: 1; }
        footer p { margin: 0 0 0.8rem 0; font-size: 0.9rem; }
        .social-icons { margin-top: 1rem; }
        .social-icons a { color: var(--white); font-size: 1.5rem; margin: 0 0.7rem; text-decoration: none; transition: var(--transition); display: inline-block; }
        .social-icons a:hover, .social-icons a:focus-visible { background: var(--highlight); -webkit-background-clip: text; -webkit-text-fill-color: transparent; transform: scale(1.2); }
        
        /* Map specific styles */
        #map-container { padding: 2.5rem 0; text-align: center; }
        #map-container h2 { font-size: 2.1rem; background: var(--primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1.75rem; }
        #map { height: 500px; width: 100%; border-radius: var(--border-radius-lg); box-shadow: var(--shadow); margin: 0 auto; max-width: 1000px; }
        /* Leaflet popup styling */
        .leaflet-popup-content-wrapper { background: var(--modal-bg); color: var(--text); border-radius: var(--border-radius-md); box-shadow: var(--shadow); }
        .leaflet-popup-content { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; font-size: 0.9rem; }
        .leaflet-popup-content strong { color: #2E4A3D; font-size: 1rem; }
        .leaflet-popup-tip { background: var(--modal-bg); }
        .leaflet-container a.leaflet-popup-close-button { color: var(--text-light); font-size: 1.5rem; padding: 4px 4px 0 0; }
        .leaflet-container a.leaflet-popup-close-button:hover { color: #2E4A3D; }

        /* Form map specific styles */
        .form-map-container { height: 220px; width: 100%; margin-bottom: 0.5rem; border-radius: var(--border-radius-md); background-color: #e9e9e9; border: 1px solid var(--border-light); }
        .form-map-instruction { display: block; margin-top: -0.8rem; margin-bottom: 1rem; font-size: 0.8rem; color: var(--text-light); }

        /* Autocomplete suggestions styling */
        .autocomplete-suggestions {
            border: 1px solid var(--border-light);
            border-top: none;
            max-height: 150px;
            overflow-y: auto;
            background-color: var(--white);
            position: relative; /* Ensures it flows in document, use absolute if complex layout needs it */
            z-index: 2005; /* High z-index to be on top of other form elements */
            margin-top: -1px; /* Align with bottom of input */
            border-bottom-left-radius: var(--border-radius-md);
            border-bottom-right-radius: var(--border-radius-md);
        }
        .autocomplete-suggestions div {
            padding: 0.6rem 0.8rem;
            cursor: pointer;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--border-light);
        }
        .autocomplete-suggestions div:last-child {
            border-bottom: none;
        }
        .autocomplete-suggestions div:hover {
            background-color: #f0f0f0;
            color: var(--primary-text-on-light-hover, #2E4A3D); /* Example text color on hover */
        }


        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 768px) { header h1 { font-size: 2rem; } header p { font-size: 1rem; } .hero h2 { font-size: 1.9rem; } .cta-section h2, .gallery h2, .how-it-works h2, #map-container h2 { font-size: 1.7rem; } .cta-sections, .gallery-grid { grid-template-columns: 1fr; } .gallery-item img { height: 220px; } .modal-content-wrapper { padding: 2rem 1.5rem; } }
        @media (max-width: 480px) { body { line-height: 1.6; } .container { padding: 0 15px; } header { padding: 1.5rem 0; } header h1 { font-size: 1.8rem; } .hero { padding: 2.5rem 1rem; } .hero h2 { font-size: 1.7rem; } .hero p { font-size: 1rem; } .cta-button, .modal-content-wrapper button[type="submit"] { padding: 0.8rem 1.5rem; font-size: 0.95rem; } .modal-content-wrapper h2 { font-size: 1.6rem; } }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Modular</h1>
            <p>Elegant Modular Living for Ireland</p>
        </div>
    </header>
    <main>
        <div class="container">
            <section class="hero" aria-labelledby="hero-title">
                <h2 id="hero-title">Craft Your Legacy with Bespoke Modular Homes</h2>
                <p>Modular connects landowners and buyers to create sustainable, luxurious living spaces that blend seamlessly with Ireland’s landscapes.</p>
            </section>
            <section class="gallery" aria-labelledby="gallery-title">
                <h2 id="gallery-title">Envision Your Future Home</h2>
                <div class="gallery-grid">
                    <div class="gallery-item" tabindex="0"><img src="https://lirp.cdn-website.com/699d2b8a/dms3rep/multi/opt/DALL-E+2025-03-10+15.37.33+-+A+serene+residential+setting+featuring+a+modern+modular+home+in+Alabama.+The+home+has+a+sleek+design+with+clean+lines-+large+windows-+and+a+well-maint-1920x1080-8c5466e5-640w.jpg" alt="Modern Modular Home with sleek design and large windows." loading="lazy"><div class="gallery-caption">Sleek modernity: Clean lines and large windows for a serene, eco-conscious home.</div></div>
                    <div class="gallery-item" tabindex="0"><img src="https://prod.rockmedialibrary.com/api/public/content/20bf155f45fa4aa49bd1be1424f25094?v=4ce3ce1a" alt="Contemporary Modular Home with bespoke design." loading="lazy"><div class="gallery-caption">Contemporary elegance: Bespoke modular design with sustainable craftsmanship.</div></div>
                    <div class="gallery-item" tabindex="0"><img src="https://www.irishtimes.com/resizer/v2/XWGYNAO2FNJPLOSZA3FD5FZHHI.jpg?auth=db8dae545d8652a9d92cf46fbfa56947bb432c8f6e8ab4d1e9da9da794534edf&smart=true&width=1600&height=900" alt="Luxurious Irish Modular Home in a natural landscape." loading="lazy"><div class="gallery-caption">Irish charm: Luxurious modular living tailored for Ireland’s landscapes.</div></div>
                </div>
            </section>
            <div class="cta-sections">
                <section class="cta-section" id="landowners-cta" aria-labelledby="landowner-title">
                    <h2 id="landowner-title">Are you Selling Land?</h2>
                    <p>Transform your land into an exclusive modular community, blending sustainability with unparalleled value.</p>
                    <a href="#landowners-cta" class="cta-button" data-modal="landowner">Offer Your Land</a>
                </section>
                <section class="cta-section" id="buyers-cta" aria-labelledby="buyer-title">
                    <h2 id="buyer-title">Are you Looking to Buy?</h2>
                    <p>Discover bespoke modular homes or prime land plots, designed for elegance and eco-conscious living.</p>
                    <a href="#buyers-cta" class="cta-button" data-modal="buyer">Find Your Dream Home</a>
                </section>
            </div>
            <section class="how-it-works" aria-labelledby="how-it-works-title">
                <h2 id="how-it-works-title">Our Process</h2>
                <ol>
                    <li>Share Your Vision: Complete our tailored interest form.</li>
                    <li>Connect Seamlessly: We match you with curated opportunities.</li>
                    <li>Craft Your Future: Build or buy with our expert guidance.</li>
                </ol>
            </section>

            <!-- MAP SECTION -->
            <section id="map-container" aria-labelledby="map-title">
                <h2 id="map-title">Explore Opportunities on the Map</h2>
                <div id="map"></div>
            </section>

        </div>
    </main>
    <div class="modal" id="form-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title-element">
        <div class="modal-content-wrapper">
            <button class="close-modal" aria-label="Close modal" type="button">×</button>
            <div id="modal-dynamic-content"></div>
        </div>
    </div>

    <template id="landowner-form-template">
        <h2 id="modal-title-element">Landowner Interest Form</h2>
        <form>
            <input type="hidden" name="formType" value="landowner">
            <label for="landowner-name">Full Name</label><input type="text" id="landowner-name" name="name" required placeholder="John Doe">
            <label for="landowner-email">Email Address</label><input type="email" id="landowner-email" name="email" required placeholder="john@example.com">
            <label for="landowner-land-size">Land Size (acres)</label><input type="number" id="landowner-land-size" name="land_size" min="0" step="0.1" placeholder="5.0">
            
            <label for="landowner-location-search">Search Location</label>
            <input type="text" id="landowner-location-search" name="location_search" placeholder="Type an address, Eircode, or town..." autocomplete="off">
            <div class="autocomplete-suggestions" id="landowner-autocomplete-suggestions" style="display: none;"></div>

            <label for="landowner-location">County</label><input type="text" id="landowner-location" name="location" placeholder="Co. Meath (auto-filled from map/search)">
            <label for="landowner-location-detail">Specific Location (Address/Description)</label><input type="text" id="landowner-location-detail" name="location_detail" placeholder="Street, Townland (auto-filled from map/search)">
            
            <label for="form-map-interactive-landowner" style="margin-top: 0.5rem; display: block;">Pinpoint Location on Map (Optional):</label>
            <div id="form-map-interactive-landowner" class="form-map-container"></div>
            <small class="form-map-instruction">Click map to set/adjust pin. Or use search above. Location fields will auto-update.</small>
            <input type="hidden" name="latitude" id="landowner-latitude">
            <input type="hidden" name="longitude" id="landowner-longitude">

            <label for="landowner-goals">Development Goals</label><textarea id="landowner-goals" name="goals" placeholder="E.g., Create a sustainable modular community"></textarea>
            <button type="submit">Submit Interest</button>
        </form>
    </template>

    <template id="buyer-form-template">
        <h2 id="modal-title-element">Buyer Interest Form</h2>
        <form>
            <input type="hidden" name="formType" value="buyer">
            <label for="buyer-name">Full Name</label><input type="text" id="buyer-name" name="name" required placeholder="Jane Smith">
            <label for="buyer-email">Email Address</label><input type="email" id="buyer-email" name="email" required placeholder="jane@example.com">
            <label for="buyer-budget">Budget (€)</label><input type="number" id="buyer-budget" name="budget" min="0" placeholder="400000">
            <label for="buyer-type">Interest Type</label><select id="buyer-type" name="type" required><option value="">Select...</option><option value="land">Land Plot Only</option><option value="home">Modular Home + Land</option></select>
            
            <label for="buyer-location-search">Search Target Location</label>
            <input type="text" id="buyer-location-search" name="location_search" placeholder="Type an address, Eircode, or town..." autocomplete="off">
            <div class="autocomplete-suggestions" id="buyer-autocomplete-suggestions" style="display: none;"></div>

            <label for="buyer-location">Target County</label><input type="text" id="buyer-location" name="location" placeholder="Co. Cork (auto-filled from map/search)">
            <label for="buyer-location-detail">Specific Preferred Location (Address/Description)</label><input type="text" id="buyer-location-detail" name="location_detail" placeholder="Rural setting, close to amenities (auto-filled from map/search)">
            
            <label for="form-map-interactive-buyer" style="margin-top: 0.5rem; display: block;">Pinpoint Preferred Area on Map (Optional):</label>
            <div id="form-map-interactive-buyer" class="form-map-container"></div>
            <small class="form-map-instruction">Click map to set/adjust pin. Or use search above. Location fields will auto-update.</small>
            <input type="hidden" name="latitude" id="buyer-latitude">
            <input type="hidden" name="longitude" id="buyer-longitude">

            <label for="buyer-preferences">Preferences</label><textarea id="buyer-preferences" name="preferences" placeholder="E.g., Eco-friendly design, 3 bedrooms, solar panels"></textarea>
            <button type="submit">Submit Interest</button>
        </form>
    </template>

    <footer>
        <div class="container">
            <p>© <span id="current-year">2025</span> Modular. All Rights Reserved.</p>
            <div class="social-icons">
                <a href="#" aria-label="Facebook" role="img">📘</a>
                <a href="#" aria-label="Twitter" role="img">🐦</a>
                <a href="#" aria-label="LinkedIn" role="img">💼</a>
            </div>
        </div>
    </footer>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwL0NKGu3AnUtkf4Z-GIMkeNnR1vulFq443ZRm5Fi6ZiRRDt45hgOzRXtVAenr51ph6/exec';
        const irelandCenter = [53.4129, -8.2439];
        const NOMINATIM_USER_AGENT = 'ModularIrelandWebsite/1.0 (Contact: info@example.com)'; // REPLACE with actual contact

        let map;
        let activeMarkers = []; 

        let formMapInstance = null; 
        let formMapMarker = null;   

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        async function fetchNominatimSearch(query) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=IE&addressdetails=1&limit=5`;
            const response = await fetch(url, { headers: { 'User-Agent': NOMINATIM_USER_AGENT } });
            if (!response.ok) throw new Error(`Nominatim search failed: ${response.statusText}`);
            return await response.json();
        }

        async function fetchNominatimReverse(lat, lon) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`;
            const response = await fetch(url, { headers: { 'User-Agent': NOMINATIM_USER_AGENT } });
            if (!response.ok) throw new Error(`Nominatim reverse geocode failed: ${response.statusText}`);
            return await response.json();
        }

        function populateFormTextFieldsFromGeo(address, displayName, formElement) {
            const countyInput = formElement.querySelector('input[name="location"]');
            const detailInput = formElement.querySelector('input[name="location_detail"]');

            if (countyInput) {
                countyInput.value = address.county || address.state || '';
            }
            if (detailInput) {
                let detailAddrParts = [];
                if (address.road) detailAddrParts.push(address.road);
                if (address.hamlet) detailAddrParts.push(address.hamlet);
                else if (address.village) detailAddrParts.push(address.village);
                else if (address.town) detailAddrParts.push(address.town);
                else if (address.city) detailAddrParts.push(address.city);
                if (address.postcode) detailAddrParts.push(address.postcode);
                
                let constructedDetail = detailAddrParts.join(', ');
                if (constructedDetail) {
                     detailInput.value = constructedDetail;
                } else {
                    let fallbackDisplay = displayName || "";
                    if (address.county && fallbackDisplay.includes(address.county)) {
                        fallbackDisplay = fallbackDisplay.replace(new RegExp(",?\\s*" + address.county + "\\b", 'gi'), '').trim();
                        if (fallbackDisplay.endsWith(',')) fallbackDisplay = fallbackDisplay.slice(0, -1).trim();
                    }
                    if (fallbackDisplay.includes("Ireland")) {
                         fallbackDisplay = fallbackDisplay.replace(/,?\s*Ireland\b/gi, '').trim();
                         if (fallbackDisplay.endsWith(',')) fallbackDisplay = fallbackDisplay.slice(0, -1).trim();
                    }
                    detailInput.value = fallbackDisplay;
                }
            }
        }
        
        async function initializeLeafletMap() {
            if (!document.getElementById('map')) {
                console.error("Main map container 'map' not found.");
                return;
            }
            if (!map) { 
                map = L.map('map', { zoomControl: true }).setView(irelandCenter, 7); // Zoom control explicitly true
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 18,
                }).addTo(map);
            }
            activeMarkers.forEach(marker => map.removeLayer(marker));
            activeMarkers = [];
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL); 
                const result = await response.json();
                if (result.status === "success" && result.data) {
                    plotLeafletMarkers(result.data);
                } else {
                    console.error("Error fetching main map data from script:", result.message || "Unknown error");
                    document.getElementById('map').innerHTML = '<p style="text-align:center; padding-top:50px;">Could not load map data.</p>';
                }
            } catch (error) {
                console.error('Error fetching or processing main map data:', error);
                document.getElementById('map').innerHTML = '<p style="text-align:center; padding-top:50px;">Error loading map data. Check console.</p>';
            }
        }

        function plotLeafletMarkers(locations) {
            if (!map) { console.error("Main Leaflet map not initialized yet."); return; }
            if (!locations || locations.length === 0) { console.log("No locations to plot on main map."); return; }
            const landownerIcon = L.icon({ iconUrl: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png', iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -28] });
            const buyerIcon = L.icon({ iconUrl: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png', iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -28] });
            locations.forEach(location => {
                if (typeof location.latitude !== 'number' || typeof location.longitude !== 'number' || isNaN(location.latitude) || isNaN(location.longitude)) {
                    console.warn("Skipping invalid location data for main map:", location); return;
                }
                const marker = L.marker([location.latitude, location.longitude], {
                    title: `${location.type}: ${location.name}`,
                    icon: location.type === "Landowner" ? landownerIcon : buyerIcon
                }).addTo(map);
                const popupContent = `<strong>${location.type}: ${location.name}</strong><br>${location.details || ''}<p><small>Lat: ${location.latitude.toFixed(4)}, Lng: ${location.longitude.toFixed(4)}</small></p>`;
                marker.bindPopup(popupContent);
                activeMarkers.push(marker);
            });
            if (activeMarkers.length > 0) {
                const group = new L.featureGroup(activeMarkers);
                if (group.getBounds().isValid()) { map.fitBounds(group.getBounds().pad(0.1)); }
                else if (activeMarkers.length === 1) { map.setView(activeMarkers[0].getLatLng(), 10); }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('current-year').textContent = new Date().getFullYear();
            
            if (typeof L !== 'undefined') {
                 initializeLeafletMap(); 
            } else {
                console.error("Leaflet library not loaded.");
                const mapDiv = document.getElementById('map');
                if(mapDiv) mapDiv.innerHTML = '<p style="text-align:center; padding-top:50px;">Map library (Leaflet) could not be loaded.</p>';
            }

            const modal = document.getElementById('form-modal');
            const modalDynamicContent = document.getElementById('modal-dynamic-content');
            const ctaButtons = document.querySelectorAll('.cta-button[data-modal]');
            const closeModalButton = modal.querySelector('.close-modal');
            let previouslyFocusedElement = null;

            function updateFormLocationFields(form, lat, lng) {
                const latInput = form.querySelector('input[name="latitude"]');
                const lonInput = form.querySelector('input[name="longitude"]');
                if (latInput) latInput.value = lat;
                if (lonInput) lonInput.value = lng;
            }
            
            function placeMarkerAndUpdate(latlng, zoomLevel = 13, setMapView = true, currentFormElement) {
                if (!formMapInstance || !currentFormElement) return;

                if (formMapMarker) {
                    try { formMapInstance.removeLayer(formMapMarker); } catch(e) { /* ignore */ }
                }
                formMapMarker = L.marker(latlng, { draggable: true }).addTo(formMapInstance);
                
                if (setMapView) {
                    formMapInstance.setView(latlng, zoomLevel);
                }
                updateFormLocationFields(currentFormElement, latlng.lat.toFixed(6), latlng.lng.toFixed(6));

                fetchNominatimReverse(latlng.lat, latlng.lng)
                    .then(data => {
                        if (data && (data.address || data.display_name)) {
                            populateFormTextFieldsFromGeo(data.address || {}, data.display_name || "", currentFormElement);
                        } else {
                             console.warn("No address details found for this location via reverse geocoding.");
                             // Clear fields if no meaningful data from reverse geocoding
                             populateFormTextFieldsFromGeo({}, "", currentFormElement); 
                        }
                    })
                    .catch(error => {
                        console.error("Reverse geocoding error:", error);
                        populateFormTextFieldsFromGeo({}, "", currentFormElement); // Clear on error too
                    });

                formMapMarker.on('dragend', function(event) {
                    const newLatLng = event.target.getLatLng();
                    updateFormLocationFields(currentFormElement, newLatLng.lat.toFixed(6), newLatLng.lng.toFixed(6));
                    fetchNominatimReverse(newLatLng.lat, newLatLng.lng)
                        .then(data => {
                            if (data && (data.address || data.display_name)) {
                                populateFormTextFieldsFromGeo(data.address || {}, data.display_name || "", currentFormElement);
                            }
                        })
                        .catch(err => console.error("Reverse geocoding error on drag:", err));
                });
            }


            function initializeFormMapAndGeolocation(formElement) {
                const formTypeInput = formElement.querySelector('input[name="formType"]');
                if (!formTypeInput) {
                    console.error("Form type input not found in form.");
                    updateFormLocationFields(formElement, '', ''); return;
                }
                const mapDivId = formTypeInput.value === 'landowner' ? 'form-map-interactive-landowner' : 'form-map-interactive-buyer';
                const formMapDiv = formElement.querySelector(`#${mapDivId}`);
                
                if (!formMapDiv) {
                    console.error("Form map div not found:", mapDivId);
                    updateFormLocationFields(formElement, '', ''); return;
                }

                if (formMapInstance) { 
                    try { formMapInstance.remove(); } catch(e) { console.warn("Error removing old formMapInstance", e); }
                    formMapInstance = null; formMapMarker = null;
                }

                formMapInstance = L.map(formMapDiv, { scrollWheelZoom: false, zoomControl: true }).setView(irelandCenter, 6);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OSM', maxZoom: 18,
                }).addTo(formMapInstance);
                
                updateFormLocationFields(formElement, '', ''); 

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            placeMarkerAndUpdate(L.latLng(position.coords.latitude, position.coords.longitude), 13, true, formElement);
                        },
                        (error) => { console.warn(`Geolocation error for form: ${error.message}.`); },
                        { enableHighAccuracy: false, timeout: 8000, maximumAge: 60000 }
                    );
                } else { console.warn('Geolocation is not supported for form map.'); }

                formMapInstance.on('click', function(e) {
                    placeMarkerAndUpdate(e.latlng, formMapInstance.getZoom(), false, formElement); 
                });
                
                // Autocomplete setup
                const searchInputId = formTypeInput.value === 'landowner' ? 'landowner-location-search' : 'buyer-location-search';
                const searchInput = formElement.querySelector(`#${searchInputId}`);
                const suggestionsContainerId = formTypeInput.value === 'landowner' ? 'landowner-autocomplete-suggestions' : 'buyer-autocomplete-suggestions';
                const suggestionsContainer = formElement.querySelector(`#${suggestionsContainerId}`);

                if (searchInput && suggestionsContainer) {
                    searchInput.addEventListener('input', debounce(async (e) => {
                        const query = e.target.value;
                        if (query.length < 3) {
                            suggestionsContainer.innerHTML = '';
                            suggestionsContainer.style.display = 'none';
                            return;
                        }
                        try {
                            const results = await fetchNominatimSearch(query);
                            displayAutocompleteSuggestions(results, suggestionsContainer, formElement, searchInput);
                        } catch (error) {
                            console.error("Autocomplete error:", error);
                            suggestionsContainer.innerHTML = '<div style="padding: 0.6rem 0.8rem; font-style: italic;">Error fetching suggestions.</div>';
                            suggestionsContainer.style.display = 'block';
                        }
                    }, 400)); // Debounce time

                    // Hide suggestions if user clicks outside search input and suggestions box
                    document.addEventListener('click', (e_doc) => {
                        if (modal.classList.contains('is-open')) { // Only act if modal is open
                           if (!searchInput.contains(e_doc.target) && !suggestionsContainer.contains(e_doc.target)) {
                                suggestionsContainer.style.display = 'none';
                            }
                        }
                    }, true); // Use capture to ensure it runs before other clicks might remove elements
                }


                setTimeout(() => { 
                    if (formMapInstance) formMapInstance.invalidateSize();
                }, 350);
            }
            
            function displayAutocompleteSuggestions(results, suggestionsContainer, formElement, searchInput) {
                suggestionsContainer.innerHTML = '';
                if (!results || results.length === 0) {
                    suggestionsContainer.innerHTML = '<div style="padding: 0.6rem 0.8rem; font-style: italic;">No results found.</div>';
                    suggestionsContainer.style.display = 'block';
                    return;
                }

                results.slice(0, 5).forEach(result => {
                    const div = document.createElement('div');
                    div.textContent = result.display_name;
                    div.addEventListener('click', () => {
                        const lat = parseFloat(result.lat);
                        const lon = parseFloat(result.lon);

                        searchInput.value = result.display_name; // Update search field with full selected name

                        updateFormLocationFields(formElement, lat, lon);
                        populateFormTextFieldsFromGeo(result.address, result.display_name, formElement);

                        if (formMapInstance) {
                            placeMarkerAndUpdate(L.latLng(lat, lon), 13, true, formElement);
                        }
                        suggestionsContainer.innerHTML = '';
                        suggestionsContainer.style.display = 'none';
                    });
                    suggestionsContainer.appendChild(div);
                });
                suggestionsContainer.style.display = 'block';
            }


            function openModal(type) {
                previouslyFocusedElement = document.activeElement;
                const templateId = `${type}-form-template`;
                const template = document.getElementById(templateId);
                if (!template) { console.error(`Template not found: ${templateId}`); return; }
                
                modalDynamicContent.innerHTML = template.innerHTML;
                const currentForm = modalDynamicContent.querySelector('form');
                
                modal.classList.add('is-open'); 
                document.body.style.overflow = 'hidden';

                if (currentForm) {
                    initializeFormMapAndGeolocation(currentForm);
                }

                const firstFocusableElement = modal.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                if (firstFocusableElement) firstFocusableElement.focus();
                
                const modalTitle = modalDynamicContent.querySelector('h2');
                if (modalTitle && modalTitle.id) modal.setAttribute('aria-labelledby', modalTitle.id);
            }

            function closeModal() {
                modal.classList.remove('is-open'); 
                document.body.style.overflow = '';
                
                if (formMapInstance) {
                    try { formMapInstance.remove(); } catch(e) { console.warn("Error removing formMapInstance on close", e); }
                    formMapInstance = null; formMapMarker = null;
                }
                modalDynamicContent.innerHTML = ''; 
                
                if (previouslyFocusedElement) previouslyFocusedElement.focus();
            }

            ctaButtons.forEach(button => {
                button.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    const type = button.getAttribute('data-modal'); 
                    openModal(type); 
                });
            });

            closeModalButton.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.classList.contains('is-open')) closeModal(); });
            
            modal.addEventListener('keydown', (e) => { 
                if (e.key !== 'Tab' || !modal.classList.contains('is-open')) return;
                const focusableElements = Array.from(modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(el => el.offsetParent !== null && !el.disabled);
                if (focusableElements.length === 0) return;
                const firstElement = focusableElements[0]; 
                const lastElement = focusableElements[focusableElements.length - 1];
                if (e.shiftKey) { 
                    if (document.activeElement === firstElement) { lastElement.focus(); e.preventDefault(); } 
                } else { 
                    if (document.activeElement === lastElement) { firstElement.focus(); e.preventDefault(); } 
                }
            });

            modalDynamicContent.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const submitButton = form.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.textContent;
                submitButton.disabled = true; submitButton.textContent = 'Submitting...';
                
                const formData = new FormData(form);
                if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.includes('YOUR_')) {
                    console.error("Google Script URL is not set correctly.");
                    alert("Configuration error: Submission URL is not set.");
                    submitButton.disabled = false; submitButton.textContent = originalButtonText; return;
                }
                try {
                    const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
                    const result = await response.json(); 
                    if (result.status === "success") {
                        alert('Success! Your information has been submitted. ' + (result.message || ''));
                        form.reset(); closeModal();
                        if (typeof L !== 'undefined' && map) { 
                            initializeLeafletMap(); 
                        }
                    } else {
                        console.error('Submission error from script:', result.message || 'Unknown error from script.');
                        alert('Error: ' + (result.message || 'Could not submit form.'));
                    }
                } catch (error) {
                    console.error('Network or fetch error:', error);
                    alert('An error occurred while submitting. Details: ' + error.message);
                } finally {
                    submitButton.disabled = false; submitButton.textContent = originalButtonText;
                }
            });
        });
    </script>
</body>
</html>
